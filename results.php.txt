<?php
// Инициализация базы данных
require_once 'db-init.php';

// Получение статистики
try {
    // Общая статистика
    $total = $pdo->query("SELECT COUNT(*) as count FROM survey_responses")->fetch()['count'];
    $today = $pdo->query("SELECT COUNT(*) as count FROM survey_responses WHERE DATE(created_at) = CURDATE()")->fetch()['count'];
    
    // Популярные технологии
    $backend_stats = $pdo->query("
        SELECT backend, COUNT(*) as count 
        FROM survey_responses 
        GROUP BY backend 
        ORDER BY count DESC
    )->fetchAll();
    
    // Статистика по ОС
    $os_stats = $pdo->query("
        SELECT os, COUNT(*) as count 
        FROM survey_responses 
        GROUP BY os 
        ORDER BY count DESC
    )->fetchAll();
    
    // Статистика по опыту
    $experience_stats = $pdo->query("
        SELECT experience, COUNT(*) as count 
        FROM survey_responses 
        GROUP BY experience 
        ORDER BY 
            CASE experience
                WHEN 'Менее года' THEN 1
                WHEN '1-3 года' THEN 2
                WHEN '3-5 лет' THEN 3
                WHEN '5-10 лет' THEN 4
                WHEN 'Более 10 лет' THEN 5
                ELSE 6
            END
    ")->fetchAll();
    
    // Последние ответы
    $recent_responses = $pdo->query("
        SELECT name, backend, experience, os, created_at 
        FROM survey_responses 
        ORDER BY created_at DESC 
        LIMIT 10
    ")->fetchAll();
    
} catch (PDOException $e) {
    die("Ошибка получения данных: " . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты опроса</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .results-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .results-header {
            background: linear-gradient(to right, #4299e1, #3182ce);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .results-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .results-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card.total .stat-icon {
            color: #48bb78;
        }
        
        .stat-card.today .stat-icon {
            color: #ed8936;
        }
        
        .stat-card.tech .stat-icon {
            color: #667eea;
        }
        
        .stat-card.os .stat-icon {
            color: #9f7aea;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 1rem;
        }
        
        .charts-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .section-title {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .recent-responses {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .responses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .responses-table th {
            background: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .responses-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        .responses-table tr:hover {
            background: #f8fafc;
        }
        
        .tech-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #c6f6d5;
            color: #22543d;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .os-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #bee3f8;
            color: #2c5282;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .experience-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #fed7d7;
            color: #742a2a;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 40px;
            color: #718096;
        }
        
        .no-data i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .actions-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 40px;
        }
        
        @media (max-width: 768px) {
            .results-header {
                padding: 30px 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-section,
            .recent-responses {
                padding: 30px 20px;
            }
            
            .responses-table {
                display: block;
                overflow-x: auto;
            }
            
            .actions-bar {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-container">
            <!-- Шапка результатов -->
            <div class="results-header">
                <h1><i class="fas fa-chart-bar"></i> Результаты опроса</h1>
                <p>Статистика по всем ответам разработчиков</p>
            </div>
            
            <!-- Быстрая статистика -->
            <div class="stats-overview">
                <div class="stat-card total">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number"><?php echo $total; ?></div>
                    <div class="stat-label">Всего участников</div>
                </div>
                
                <div class="stat-card today">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-number"><?php echo $today; ?></div>
                    <div class="stat-label">Ответов сегодня</div>
                </div>
                
                <div class="stat-card tech">
                    <div class="stat-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="stat-number">
                        <?php echo !empty($backend_stats) ? $backend_stats[0]['backend'] : '—'; ?>
                    </div>
                    <div class="stat-label">Популярная технология</div>
                </div>
                
                <div class="stat-card os">
                    <div class="stat-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div class="stat-number">
                        <?php echo !empty($os_stats) ? $os_stats[0]['os'] : '—'; ?>
                    </div>
                    <div class="stat-label">Популярная ОС</div>
                </div>
            </div>
            
            <?php if ($total > 0): ?>
                <!-- Графики -->
                <div class="charts-section">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie"></i> Детальная статистика
                    </h2>
                    
                    <div class="charts-grid">
                        <!-- График языков программирования -->
                        <div>
                            <h3 class="section-title">
                                <i class="fas fa-code"></i> Языки программирования
                            </h3>
                            <div class="chart-container">
                                <canvas id="backendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- График операционных систем -->
                        <div>
                            <h3 class="section-title">
                                <i class="fas fa-desktop"></i> Операционные системы
                            </h3>
                            <div class="chart-container">
                                <canvas id="osChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- График опыта -->
                    <div>
                        <h3 class="section-title">
                            <i class="fas fa-user-clock"></i> Опыт разработчиков
                        </h3>
                        <div class="chart-container">
                            <canvas id="experienceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Последние ответы -->
                <div class="recent-responses">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i> Последние ответы
                    </h2>
                    
                    <div class="table-responsive">
                        <table class="responses-table">
                            <thead>
                                <tr>
                                    <th>Имя</th>
                                    <th>Основной язык</th>
                                    <th>Опыт</th>
                                    <th>ОС</th>
                                    <th>Время</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($recent_responses as $response): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($response['name']); ?></td>
                                    <td><span class="tech-badge"><?php echo $response['backend']; ?></span></td>
                                    <td><span class="experience-badge"><?php echo $response['experience']; ?></span></td>
                                    <td><span class="os-badge"><?php echo $response['os']; ?></span></td>
                                    <td><?php echo date('H:i d.m.Y', strtotime($response['created_at'])); ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            <?php else: ?>
                <!-- Сообщение, если нет данных -->
                <div class="no-data">
                    <i class="fas fa-database"></i>
                    <h2>Данные отсутствуют</h2>
                    <p>Пока никто не прошел опрос. Будьте первым!</p>
                    <div style="margin-top: 30px;">
                        <a href="survey.php" class="btn btn-primary" style="width: auto;">
                            <i class="fas fa-edit"></i> Пройти опрос первым
                        </a>
                    </div>
                </div>
            <?php endif; ?>
            
            <!-- Действия -->
            <div class="actions-bar">
                <a href="survey.php" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Пройти опрос
                </a>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-home"></i> На главную
                </a>
            </div>
        </div>
    </div>

    <script>
        // Данные для графиков из PHP
        const backendData = <?php echo json_encode($backend_stats); ?>;
        const osData = <?php echo json_encode($os_stats); ?>;
        const experienceData = <?php echo json_encode($experience_stats); ?>;
        
        // Цвета для графиков
        const chartColors = [
            '#667eea', '#764ba2', '#48bb78', '#ed8936',
            '#f56565', '#4299e1', '#9f7aea', '#ed64a6',
            '#38b2ac', '#ecc94b'
        ];
        
        // График языков программирования
        if (backendData.length > 0) {
            const backendCtx = document.getElementById('backendChart').getContext('2d');
            new Chart(backendCtx, {
                type: 'doughnut',
                data: {
                    labels: backendData.map(item => item.backend),
                    datasets: [{
                        data: backendData.map(item => item.count),
                        backgroundColor: chartColors.slice(0, backendData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = backendData.reduce((sum, item) => sum + item.count, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // График операционных систем
        if (osData.length > 0) {
            const osCtx = document.getElementById('osChart').getContext('2d');
            new Chart(osCtx, {
                type: 'polarArea',
                data: {
                    labels: osData.map(item => item.os),
                    datasets: [{
                        data: osData.map(item => item.count),
                        backgroundColor: chartColors.slice(0, osData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
        
        // График опыта
        if (experienceData.length > 0) {
            const experienceCtx = document.getElementById('experienceChart').getContext('2d');
            new Chart(experienceCtx, {
                type: 'bar',
                data: {
                    labels: experienceData.map(item => item.experience),
                    datasets: [{
                        label: 'Количество человек',
                        data: experienceData.map(item => item.count),
                        backgroundColor: chartColors.slice(0, experienceData.length),
                        borderColor: '#fff',
                        borderWidth: 2,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Обновление статистики каждые 30 секунд
        function updateStats() {
            fetch('api/stats.php')
                .then(response => response.json())
                .then(data => {
                    // Обновляем карточки статистики
                    const statCards = document.querySelectorAll('.stat-card');
                    if (statCards[0]) {
                        statCards[0].querySelector('.stat-number').textContent = data.total || 0;
                    }
                    if (statCards[1]) {
                        statCards[1].querySelector('.stat-number').textContent = data.today || 0;
                    }
                    if (statCards[2] && data.top_tech) {
                        statCards[2].querySelector('.stat-number').textContent = data.top_tech;
                    }
                })
                .catch(console.error);
        }
        
        // Обновляем статистику каждые 30 секунд
        if (<?php echo $total; ?> > 0) {
            setInterval(updateStats, 30000);
        }
    </script>
</body>
</html>